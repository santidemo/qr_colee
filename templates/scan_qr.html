<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Escanear Código QR</title>
    <style>
        /* Estilos CSS para el contenedor de la cámara */
        #qr-reader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
        }

        /* Estilos CSS para el área del visor de la cámara */
        #qr-reader {
            width: 100%;
            max-width: 600px;
            height: auto;
            margin-bottom: 20px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Escanear Código QR</h1>

    <div id="qr-reader-container">
        <video id="qr-reader" autoplay></video>
        <button onclick="startScanner()">Activar Cámara</button>
        <p id="qr-result">Aquí aparecerá el resultado del escaneo...</p>
    </div>

    <!-- Formulario para registrar asistencia -->
    <form id="asistencia-form" action="{{ url_for('registrar_asistencia') }}" method="post">
        <input type="hidden" id="qr_data" name="qr_data" required>
        <label for="llegada">Llegada:</label>
        <select id="llegada" name="llegada" required>
            <option value="Tarde">Tarde</option>
            <option value="Bien">Bien</option>
            <option value="Falta">Falta</option>
        </select>
        <br>
        <button type="submit">Registrar Asistencia</button>
    </form>

    <a href="{{ url_for('index') }}">Volver al Registro de Alumnos</a>

    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
        function startScanner() {
            const qrReader = document.getElementById('qr-reader');
            const qrResult = document.getElementById('qr-result');
            const qrDataInput = document.getElementById('qr_data');

            // Verificar si el navegador soporta la API de getUserMedia
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Obtener permiso para usar la cámara
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function(stream) {
                        qrReader.srcObject = stream;
                        qrResult.textContent = 'Escaneando...';

                        // Crear un detector de QR usando la librería `ZXing`
                        const codeReader = new ZXing.BrowserQRCodeReader();
                        codeReader.decodeFromVideoDevice(undefined, 'qr-reader', (result, err) => {
                            if (result) {
                                qrResult.textContent = result.text;
                                qrDataInput.value = result.text;
                            }
                            if (err && !(err instanceof ZXing.NotFoundException)) {
                                console.error(err);
                                qrResult.textContent = 'Error al escanear. Inténtalo nuevamente.';
                            }
                        });
                    })
                    .catch(function(err) {
                        console.error('Error al acceder a la cámara:', err);
                        qrResult.textContent = 'Error al acceder a la cámara. Verifica los permisos.';
                    });
            } else {
                qrResult.textContent = 'Tu navegador no soporta la captura de video.';
            }
        }
    </script>
</body>
</html>
